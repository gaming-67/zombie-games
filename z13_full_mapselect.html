<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Z-13: The Quarantine — Map Select Full Build</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--accent:#c73b3b;--muted:#b9bcc0;--glass:rgba(8,8,10,0.66)}
html,body{height:100%;margin:0;background:#020306;color:#fff;font-family:Inter,system-ui,Segoe UI,Arial;overflow:hidden}
canvas{display:block;width:100%;height:100vh}
.center-full{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:999}
.card{background:linear-gradient(180deg,rgba(0,0,0,0.55),rgba(0,0,0,0.45));border-radius:14px;padding:14px;box-shadow:0 14px 40px rgba(0,0,0,0.6);backdrop-filter: blur(6px)}
.row{display:flex;gap:12px}
.col{display:flex;flex-direction:column;gap:8px}
.btn{background:var(--accent);border:none;color:#fff;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
.small{font-size:13px;color:var(--muted)}
.menuOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:998;pointer-events:none}
.menuInner{pointer-events:auto}
#hud{position:fixed;left:12px;top:12px;z-index:960;background:var(--glass);padding:10px;border-radius:10px;display:none}
#weaponUI{position:fixed;right:12px;bottom:12px;z-index:961;background:var(--glass);padding:10px;border-radius:10px;display:none}
#cross{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:962;display:none;font-size:20px}
#minimap{position:fixed;right:12px;bottom:12px;z-index:970;width:220px;height:220px;border-radius:10px;background:rgba(0,0,0,0.45);display:none}
#pauseOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:990}
.pauseCard{background:rgba(0,0,0,0.86);padding:16px;border-radius:12px;text-align:center}
.infoBox{width:780px;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(12,12,14,0.96),rgba(6,6,8,0.92))}
.saveToast{position:fixed;right:12px;bottom:12px;padding:10px;border-radius:8px;background:rgba(0,0,0,0.6);z-index:995}
.mapSelectGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.mapCard{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(0,0,0,0.08));padding:12px;border-radius:10px}
.smallNote{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<canvas id="mainCanvas"></canvas>

<!-- Cinematic background + menu overlay -->
<div id="menu" class="menuOverlay" style="display:flex">
  <div class="menuInner">
    <div class="card" style="width:min(1080px,94vw);display:flex;gap:12px">
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:12px">
          <svg width="72" height="72"><rect rx="6" width="72" height="72" fill="#07070a"/><path d="M12 28h48v16H12z" fill="#c73b3b"/></svg>
          <div>
            <h1 style="margin:0">Z-13: The Quarantine</h1>
            <div class="small">Map Select & Full Build — Prototype</div>
          </div>
        </div>
        <div style="margin-top:12px" class="smallNote">Choose a map to begin. Weapons unlock as you progress through waves. Save/Load uses localStorage.</div>
      </div>
      <div style="width:320px">
        <div class="col">
          <button id="btnMapSelect" class="btn">Map Select</button>
          <button id="btnPlay" class="btn ghost">Quick Play (City)</button>
          <button id="btnHow" class="btn ghost">How to Play</button>
          <button id="btnSettings" class="btn ghost">Settings</button>
          <button id="btnCredits" class="btn ghost">Credits</button>
          <button id="btnLoad" class="btn ghost">Load Save</button>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card" style="width:min(1080px,94vw)">
      <div class="mapSelectGrid" id="mapGrid">
        <!-- map cards populated by JS -->
      </div>
    </div>
  </div>
</div>

<!-- How to / Settings / Credits -->
<div id="how" class="center-full" style="display:none"><div class="infoBox">
  <h2>How to Play</h2>
  <p>WASD to move • Mouse to look • Left click to shoot • R reload • 1–8 switch weapons • F flashlight • E pick up • T interact • M toggle map • Esc pause</p>
  <div style="text-align:right"><button id="howBack" class="btn">Back</button></div>
</div></div>

<div id="settings" class="center-full" style="display:none"><div class="infoBox">
  <h2>Settings</h2>
  <div style="display:flex;gap:12px;align-items:center"><div>Sound</div><input id="soundToggle" type="checkbox" checked></div>
  <div style="margin-top:8px"><div>Mouse Sensitivity</div><input id="sens" type="range" min="0.8" max="3.2" step="0.1" value="1.0"></div>
  <div style="text-align:right;margin-top:8px"><button id="settingsBack" class="btn">Back</button></div>
</div></div>

<div id="credits" class="center-full" style="display:none"><div class="infoBox">
  <h2>Credits</h2>
  <p>Prototype built by ChatGPT — you're the creative director ✨</p>
  <div style="text-align:right"><button id="creditsBack" class="btn">Back</button></div>
</div></div>

<!-- HUD -->
<div id="hud">
  <div>HP <b id="hp">100</b> • Wave <b id="wave">0</b> • Score <b id="score">0</b></div>
  <div class="smallNote">Battery <span id="bat">100%</span> • Infection <span id="inf">0%</span></div>
</div>
<div id="weaponUI" style="display:none"><div id="wname">Pistol</div><div class="smallNote">Ammo <span id="ammo">12</span>/<span id="res">48</span></div></div>
<div id="cross" style="display:none">+</div>
<div id="pickup" style="position:fixed;left:50%;bottom:18%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:6px;border-radius:8px;display:none;z-index:980">[E] Pick up</div>
<div id="interact" style="position:fixed;left:50%;bottom:22%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:6px;border-radius:8px;display:none;z-index:980">[T] Interact</div>

<!-- Pause -->
<div id="pauseOverlay"><div class="pauseCard">
  <h2 id="pauseTitle">Paused</h2>
  <div style="margin-top:8px">
    <button id="resume" class="btn">Resume</button>
    <button id="pauseSettings" class="btn ghost">Settings</button>
    <button id="saveBtn" class="btn">Save</button>
    <button id="toMenu" class="btn ghost">Main Menu</button>
  </div>
</div></div>

<!-- Minimap -->
<div id="minimap"><canvas id="miniCanvas"></canvas></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
/*
  Z-13 Full Build with Map Select
  - Single-file prototype
  - Map Select: City, Quarantine Facility, Subway Tunnels
  - Expanded weapons, zombies, boss (every 5 waves)
  - Missions, traders, crafting placeholders, audio tones
  - Save/load to localStorage
*/

/* -------------------------
   Utility & UI elements
   ------------------------- */
const canvas = document.getElementById('mainCanvas');
const menuDiv = document.getElementById('menu');
const mapGrid = document.getElementById('mapGrid');
const howDiv = document.getElementById('how');
const settingsDiv = document.getElementById('settings');
const creditsDiv = document.getElementById('credits');
const hud = document.getElementById('hud'), weaponUI = document.getElementById('weaponUI'), cross = document.getElementById('cross');
const pickupPrompt = document.getElementById('pickup'), interactPrompt = document.getElementById('interact');
const pauseOverlay = document.getElementById('pauseOverlay'), pauseTitle = document.getElementById('pauseTitle');
const minimapDiv = document.getElementById('minimap'), miniCanvas = document.getElementById('miniCanvas');

document.getElementById('btnHow').onclick = ()=>{ menuDiv.style.display='none'; howDiv.style.display='flex'; }
document.getElementById('howBack').onclick = ()=>{ howDiv.style.display='none'; menuDiv.style.display='flex'; }
document.getElementById('btnSettings').onclick = ()=>{ menuDiv.style.display='none'; settingsDiv.style.display='flex'; }
document.getElementById('settingsBack').onclick = ()=>{ settingsDiv.style.display='none'; menuDiv.style.display='flex'; }
document.getElementById('btnCredits').onclick = ()=>{ menuDiv.style.display='none'; creditsDiv.style.display='flex'; }
document.getElementById('creditsBack').onclick = ()=>{ creditsDiv.style.display='none'; menuDiv.style.display='flex'; }

/* -------------------------
   game config & state
   ------------------------- */
let renderer, scene, camera, clock;
let running=false, paused=false, gameStarted=false;
let audioCtx=null;
function ensureAudio(){ if(!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ audioCtx=null; } } }
function sfx(freq=440,dur=0.06,type='sine',vol=0.12){ if(!audioCtx) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); g.gain.value=0.0001; g.gain.linearRampToValueAtTime(vol,audioCtx.currentTime+0.01); o.start(); o.stop(audioCtx.currentTime+dur); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+dur); }

let player = {hp:100,score:0,battery:100,infection:0,position:new THREE.Vector3(0,1.6,0)};
let wave=0, killsThisWave=0, zombiesThisWave=0;
let zombies=[], pickups=[], entities=[], props=[];
let keys={}, controlsEnabled=false;
let weaponState={}, currentWeapon='pistol';
let inventory={grenades:2,medkits:1,armor:0};
let lastFrame = performance.now(), lastSpawn = 0;
const MAPS = [
  {id:'city', name:'City Ruins', desc:'Open streets, tall buildings, alley ambushes', fog:0x0b0c10},
  {id:'facility', name:'Quarantine Facility', desc:'Indoors, flickering lights, terminals', fog:0x060608},
  {id:'subway', name:'Subway Tunnels', desc:'Tight corridors, darkness, echoes', fog:0x040306}
];
let selectedMap = MAPS[0];

/* -------------------------
   weapons list
   ------------------------- */
const weapons = {
  pistol:{name:'Pistol',mag:12,reserve:72,rate:260,damage:8,auto:false,reload:900,unlock:0},
  smg:{name:'SMG',mag:30,reserve:120,rate:70,damage:3,auto:true,reload:1000,unlock:2},
  shotgun:{name:'Shotgun',mag:8,reserve:40,rate:850,damage:18,pellets:8,auto:false,reload:1400,unlock:3},
  rifle:{name:'Assault Rifle',mag:30,reserve:120,rate:110,damage:12,auto:true,reload:1400,unlock:4},
  sniper:{name:'Sniper',mag:5,reserve:15,rate:900,damage:48,auto:false,reload:2000,unlock:5},
  flamethrower:{name:'Flamethrower',mag:100,reserve:300,rate:60,damage:0.9,auto:true,reload:4000,unlock:6},
  gl:{name:'Grenade Launcher',mag:6,reserve:18,rate:900,damage:30,area:true,auto:false,reload:2000,unlock:7},
  bat:{name:'Bat',mag:1,reserve:0,rate:400,damage:18,melee:true,auto:false,unlock:0}
};
for(const k in weapons) weaponState[k] = {ammo:weapons[k].mag, reserve:weapons[k].reserve, reloading:false, lastShot:0};

/* -------------------------
   UI updates
   ------------------------- */
function updateHUD(){
  document.getElementById('hp').textContent = Math.max(0, Math.floor(player.hp));
  document.getElementById('score').textContent = player.score;
  document.getElementById('bat').textContent = Math.max(0, Math.floor(player.battery)) + '%';
  document.getElementById('inf').textContent = Math.floor(player.infection) + '%';
  document.getElementById('wname')?.remove?.(); // placeholder
  // weapon UI:
  if(weaponUI.style.display !== 'none'){
    const st = weaponState[currentWeapon] || {ammo:0, reserve:0};
    document.getElementById('wname').textContent = weapons[currentWeapon].name;
    document.getElementById('ammo').textContent = st.ammo; document.getElementById('res').textContent = st.reserve;
  }
}

/* -------------------------
   dynamic map cards (Map Select)
   ------------------------- */
function buildMapGrid(){
  mapGrid.innerHTML='';
  MAPS.forEach((m,i)=>{
    const div = document.createElement('div'); div.className='mapCard';
    div.innerHTML = `<strong>${m.name}</strong><div class="small">${m.desc}</div><div style="height:8px"></div><button class="btn" data-map="${m.id}">Select</button>`;
    mapGrid.appendChild(div);
    div.querySelector('button').onclick = ()=>{ selectMap(m.id); };
  });
}
function selectMap(id){
  selectedMap = MAPS.find(x=>x.id===id) || MAPS[0];
  showToast('Selected: ' + selectedMap.name);
}

/* -------------------------
   Cinematic menu (silent skyline) — reused pattern
   ------------------------- */
let menuScene, menuCam, menuRenderer, menuAnim;
function initMenuCinematic(){
  menuRenderer = new THREE.WebGLRenderer({canvas,antialias:true});
  menuRenderer.setSize(innerWidth,innerHeight);
  menuRenderer.setPixelRatio(Math.min(window.devicePixelRatio||1,1.5));
  menuScene = new THREE.Scene(); menuScene.background = new THREE.Color(0x030305);
  menuCam = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.1, 2000);
  menuCam.position.set(0,40,120);
  const amb = new THREE.AmbientLight(0x11121a,0.8); menuScene.add(amb);
  const moon = new THREE.DirectionalLight(0x6fa2ff,0.35); moon.position.set(-80,120,40); menuScene.add(moon);
  // procedural skyline
  const city = new THREE.Group();
  const grid=10, spacing=14;
  for(let x=-grid;x<=grid;x++){ for(let z=-grid;z<=grid;z++){
    const w=8+Math.random()*18, h=10+Math.random()*60, d=8+Math.random()*18;
    const b = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), new THREE.MeshStandardMaterial({color:0x0b0c0f,roughness:0.9}));
    b.position.set(x*spacing+(Math.random()-0.5)*4, h/2 + (Math.random()-0.5)*4, z*spacing+(Math.random()-0.5)*4);
    // window sprites
    for(let r=0;r<Math.floor(h/3);r++){ for(let c=0;c<Math.floor(w/2);c++){
      if(Math.random()<0.12){ const sp=new THREE.Sprite(new THREE.SpriteMaterial({color:0x6fa2ff,opacity:0.02})); sp.scale.set(1.2,0.8,1); sp.position.set((c - Math.floor(w/2)/2)*0.5 + (Math.random()-0.5)*0.06, (r - Math.floor(h/3)/2)*0.8 + (Math.random()-0.5)*0.06, 0.51); sp.userData={phase:Math.random()*6, warm:Math.random()<0.6}; b.add(sp); }
    } }
    city.add(b);
  } }
  city.scale.set(1.6,1.6,1.6);
  menuScene.add(city); menuScene.userData.city = city;
  menuDiv.style.display='flex';
  animateMenu();
}
function animateMenu(){
  menuAnim = requestAnimationFrame(animateMenu);
  const t = performance.now()*0.001;
  const radius=120, speed=0.03;
  menuCam.position.x = Math.cos(t*speed)*radius; menuCam.position.z = Math.sin(t*speed)*radius*0.9; menuCam.position.y = 38 + Math.sin(t*0.12)*6;
  menuCam.lookAt(0,8,0);
  menuScene.traverse(o=>{ if(o.type==='Sprite' && o.userData){ const p=o.userData; const flick = 0.2 + (Math.sin(t*6 + p.phase) * 0.5 + Math.random()*0.08); o.material.opacity = 0.02 + Math.max(0,Math.min(1,flick))*0.14; o.material.color.setHex(p.warm?0xffd08a:0x6fa2ff); }});
  menuRenderer.render(menuScene, menuCam);
}

/* -------------------------
   Start Game: initialize main scene based on selectedMap
   ------------------------- */
function startGame(){
  // stop menu
  cancelAnimationFrame(menuAnim); menuDiv.style.display='none';
  // start main renderer on same canvas
  renderer = new THREE.WebGLRenderer({canvas,antialias:true});
  renderer.setSize(innerWidth
